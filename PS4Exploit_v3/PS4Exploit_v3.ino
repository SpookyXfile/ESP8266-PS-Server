

#include <ESP8266FtpServer.h>

#include <ESP8266WiFi.h>
#include <WiFiClient.h>
#include <ESP8266WebServer.h>

#include <ESP8266mDNS.h>
#include <DNSServer.h>

#include <FS.h>


//#include <pgmspace.h>
//#include <WString.h>

//#define PROGMEM   ICACHE_RODATA_ATTR
//#define ICACHE_RODATA_ATTR  __attribute__((section(".irom.text")))

//#define FPSTR(pstr_pointer) (reinterpret_cast<const __FlashStringHelper *>(pstr_pointer))
//#define F(string_literal) (FPSTR(PSTR(string_literal)))

//String(const char *cstr = ""); // constructor from const char *
//String(const String &str); // copy constructor
//String(const __FlashStringHelper *str); // constructor for flash strings

//static const char xyz[] PROGMEM = "This is a string stored in flash";
//static const char xyz[] = "This is a string stored in flash";
//Serial.println(FPSTR(xyz));

//String mystring(F("This string is stored in flash"));
//String mystring( FPSTR( "This string is stored in flash" ) );
//String mystring_2( FPSTR( "This string is stored in flash number 2" ) );


// Comment DEBUG to disable debug output
#define DEBUG

// Comment SLEEP to disable MCU sleep mode
// #define SLEEP

//#define NO_CONFIG 1
bool noConfig = false;

#ifdef DEBUG
  #define DBG_OUTPUT_PORT Serial
#endif

// FTP config access
String userIdentity = "ESPS4";
String userPassword = "password";
FtpServer ftpSrv;

//DNS settings
const byte DNS_PORT = 53;
DNSServer dnsServer;

//payload settings
char jsCounter = 0;
char JS_MAX = 7;
WiFiClient ps4;
String ps4IP;
int ps4Port = 9020;
#define PACKET_SIZE 4096
char plPacket[ PACKET_SIZE ];
#define PAYLOAD_WAIT 0

ESP8266WebServer server( 80 );
String host = "ps4exploit";

//AP settings
bool revertToAP = false;
IPAddress local_IP( 10, 13, 37, 1 );
IPAddress gateway( 10, 13, 37, 9 );
IPAddress subnet( 255, 255, 255, 0 );

//default settings
String wifiMode = "ap";
String apName = "ps4exploit";
String apKey = "hackmyps4";
String stName = "yourrouter";
String stKey = "routerpassword";
String stAddress = "235";
String payload = "/ps4-ftp-vtx.bin";

#ifndef D5
  #define D5 14
#endif
#define resetPin D5

void uploadPayload()
{

#ifdef DEBUG
  DBG_OUTPUT_PORT.println( ps4IP );
#endif

  int tCounter = 0;

  while ( !ps4.connect( ps4IP.c_str(), ps4Port ) )
  {
    tCounter++;

    if ( tCounter > 5000 )
    {
      #ifdef DEBUG
        DBG_OUTPUT_PORT.println( "Couldn't connect" );
      #endif
      
      jsCounter = 0;
      ps4.stop();
      return;

    }

  }

  File file = SPIFFS.open( payload, "r" );

  if ( !file )
  {
    #ifdef DEBUG
      DBG_OUTPUT_PORT.printf( "%s couldn't be opened!\n", payload.c_str() );
    #endif
    
    ps4.stop();
    return;

  }

  // Mod by trident
  //int filelen = file.size();
  
  #ifdef DEBUG
    DBG_OUTPUT_PORT.printf( "Sending payload %s to %s port %d\r\n", file.name(), ps4IP.c_str(), ps4Port );
  #endif
  
  //while ( ps4.available() ) { ps4.read(); }

  int totalSent = 0;

  while ( file.available() > 0 )
  {
    int i = file.readBytes(plPacket, PACKET_SIZE );
    totalSent += ps4.write( ( const uint8_t* )plPacket, i );
    
    #ifdef DEBUG
      // Mod by trident
      //DBG_OUTPUT_PORT.printf( "%d\%%\n", ( int )( ( totalSent * 100 ) / filelen ) );
      DBG_OUTPUT_PORT.printf( "%d\%%\n", ( int )( ( totalSent * 100 ) / (int)file.size() ) );
    #endif
    
    ps4.flush();
  }

  file.close();

  #ifdef DEBUG
    DBG_OUTPUT_PORT.println( "Payload sent" );
  #endif
  
  ps4.stop();
  jsCounter = 0;

  delay( 250 );

  if ( payload == "/jkpatch.bin" )
  {
    while ( !ps4.connect( ps4IP.c_str(), 9023 ) )
    {
      tCounter++;

      if ( tCounter > 5000 )
      {
        #ifdef DEBUG
          DBG_OUTPUT_PORT.println( "Couldn't connect" );
        #endif
        
        jsCounter = 0;
        ps4.stop();
        return;
  
      }

    }

    File file = SPIFFS.open( "/kpayload.elf", "r" );
  
    if ( !file )
    {
      #ifdef DEBUG
        DBG_OUTPUT_PORT.printf( "%s couldn't be opened!\n", payload.c_str() );
      #endif
      
      ps4.stop();
      return;
  
    }
  
    // Mod by trident
    //int filelen = file.size();
    
    #ifdef DEBUG
      DBG_OUTPUT_PORT.printf( "Sending %s to %s port 9023\r\n", file.name(), ps4IP.c_str() );
    #endif
    
    //while ( ps4.available() ) { ps4.read(); }
  
    int totalSent = 0;
  
    while ( file.available() > 0 )
    {
      int i = file.readBytes( plPacket, PACKET_SIZE );
      totalSent += ps4.write( ( const uint8_t* )plPacket, i );
      
      #ifdef DEBUG
        // Mod by trident
        //DBG_OUTPUT_PORT.printf( "%d\%%\n", ( int )( ( totalSent * 100 ) / filelen ) );
        DBG_OUTPUT_PORT.printf( "%d\%%\n", ( int )( ( totalSent * 100 ) / (int)file.size() ) );
      #endif
      
      ps4.flush();
    }
  
    file.close();
  
    #ifdef DEBUG
      DBG_OUTPUT_PORT.println( "ELF sent" );
    #endif
    
    ps4.stop();
    jsCounter = 0;
  }

}

void loadConfig() {

  File file = SPIFFS.open( "/settings.ini", "r" );

  if ( !file )
  {
    #ifdef DEBUG
      DBG_OUTPUT_PORT.println( "settings.ini couldn't be opened!" );
    #endif
    
    return;

  }

  String thisLine;

  while ( 1 )
  {
    thisLine = file.readStringUntil( '\r' );
    thisLine.trim();
    if ( thisLine.indexOf( "wifimode=" ) == 0 ) wifiMode = thisLine.substring( 9 );
    if ( thisLine.indexOf( "apname=" ) == 0 ) apName = thisLine.substring( 7 );
    if ( thisLine.indexOf( "apkey=" ) == 0 ) apKey = thisLine.substring( 6 );
    if ( thisLine.indexOf( "stname=" ) == 0 ) stName = thisLine.substring( 7 );
    if ( thisLine.indexOf( "stkey=" ) == 0 ) stKey = thisLine.substring( 6 );
    if ( thisLine.indexOf( "staddress=" ) == 0 ) stAddress = thisLine.substring( 10 );
    if ( thisLine.indexOf( "payload=" ) == 0 ) payload = thisLine.substring( 8 );
    if ( ( thisLine.length() == 0 ) || !thisLine.indexOf( "=" ) ) break;

  }

  file.close();

  #ifdef DEBUG
    DBG_OUTPUT_PORT.println( "settings.ini loaded" );
  #endif

}

void saveConfig()
{
  File file = SPIFFS.open( "/settings.ini", "w" );

  for ( int i = 0; i < server.args(); i++ )
  {
    String settingsLine = server.argName( i ) + "=" + server.arg( i );
    file.println( settingsLine.c_str() );

  }

  file.close();
  
  file = SPIFFS.open( "/settings.ini", "r" );
  char tempChar[ 400 ];
  file.readBytes( tempChar, 400 );
  
  #ifdef DEBUG
    DBG_OUTPUT_PORT.println( tempChar );
  #endif
  
  file.close();
  
  loadConfig();

}


String getContentType( String filename )
{

  if ( server.hasArg( "download" ) ) 
    return "application/octet-stream";
  
  else if ( filename.endsWith( ".htm") ) return "text/html";
  else if ( filename.endsWith( ".html" ) ) return "text/html";
  else if ( filename.endsWith( ".css" ) ) return "text/css";
  else if ( filename.endsWith( ".js" ) ) return "application/javascript";
  else if ( filename.endsWith( ".png" ) ) return "image/png";
  else if ( filename.endsWith( ".gif" ) ) return "image/gif";
  else if ( filename.endsWith( ".jpg" ) ) return "image/jpeg";
  else if ( filename.endsWith( ".ico" ) ) return "image/x-icon";
  else if ( filename.endsWith( ".gz" ) ) return "application/x-gzip";
  
  return "text/plain";

}

bool handleFileRead( String path )
{
  path = path.substring( path.lastIndexOf( "/" ) );
  ps4IP = server.client().remoteIP().toString();

  if ( path.endsWith( ".html" ) || path.endsWith( ".htm" ) )
  {
    jsCounter = 0;
    JS_MAX = 100;

  }

  if ( path.endsWith( ".js" ) )
    jsCounter ++;
  
  #ifdef DEBUG
    DBG_OUTPUT_PORT.println( "handleFileRead: " + path );
  #endif
  
  if ( path.endsWith( "/" ) ) path = "/index.html";
  if ( path.length()  < 3 ) path = "/index.html";
 
  //set up trigger for payload transfer
  if ( path.endsWith( "payloadbin.html" ) ) JS_MAX = 5;
  if ( path.endsWith( "hen-payload.html" ) ) JS_MAX = 6;
  if ( path.endsWith( "ftp-payload.html" ) ) JS_MAX = 6;
  if ( path.endsWith( "EnUpdate-payload.html" ) ) JS_MAX = 6;
  if ( path.endsWith( "DisUpdate-payload.html" ) ) JS_MAX = 6;
   if ( path.endsWith( "jkpatch-payload.html" ) ) JS_MAX = 6;
  
  String contentType = getContentType( path );
  String pathWithGz = path + ".gz";

  if ( SPIFFS.exists( pathWithGz ) || SPIFFS.exists( path ) )
  {
    if ( SPIFFS.exists( pathWithGz ) )
      path += ".gz";
    
    File file = SPIFFS.open( path, "r" );

    // Mod by trident
    //size_t sent = server.streamFile( file, contentType );
    server.streamFile( file, contentType );
    
    file.close();
   
    return true;

  }

  return false;

}


#ifdef SLEEP
  unsigned char buttonPin = 3;
  unsigned char buttonState;             // the current reading from the input pin
  unsigned char lastButtonState = HIGH;   // the previous reading from the input pin
  
  // the following variables are unsigned longs because the time, measured in
  // milliseconds, will quickly become a bigger number than can be stored in an int.
  unsigned long lastDebounceTime = 0;  // the last time the output pin was toggled
  unsigned long debounceDelay = 50;    // the debounce time; increase if the output flickers
#endif

void setup( void )
{

  pinMode( resetPin, INPUT_PULLUP );

#ifdef SLEEP  
  pinMode( buttonPin, INPUT_PULLUP );
#endif

  pinMode( LED_BUILTIN, OUTPUT );
  digitalWrite( LED_BUILTIN, HIGH );

  WiFi.forceSleepBegin();

  #ifdef DEBUG
    DBG_OUTPUT_PORT.begin( 115200 );
    DBG_OUTPUT_PORT.print( "\n" );
  #endif
 
  SPIFFS.begin();

  // Mod by trident
  //ftpSrv.begin("ESPS4","password");
  ftpSrv.begin( userIdentity, userPassword );
  
  Dir dir = SPIFFS.openDir( "/" );

  if ( digitalRead( resetPin ) == LOW )
  {
    #ifdef DEBUG
      DBG_OUTPUT_PORT.println( "Config loading bypassed!" );
    #endif
    
    noConfig = true;
    wifiMode = "ap";

  }

#ifndef NO_CONFIG
  if ( noConfig == false ) loadConfig();
#endif

  if ( wifiMode == "ap" )
  {
    WiFi.mode( WIFI_AP );

    if ( WiFi.softAPConfig( local_IP, gateway, subnet ) == false )
    {
      #ifdef DEBUG
        DBG_OUTPUT_PORT.println( "Couldn't create AP" );
      #endif

    }
    else
    {
      #ifdef DEBUG
        DBG_OUTPUT_PORT.printf( "Creating AP " );
        DBG_OUTPUT_PORT.println( apName );
      #endif

    }

    while ( WiFi.softAP( apName.c_str(), apKey.c_str() ) == false )
    {
      delay( 500 );
      #ifdef DEBUG
        DBG_OUTPUT_PORT.print( "." );
      #endif  

    }

    if ( WiFi.softAPIP() == IPAddress( 0, 0, 0, 0 ) )
      revertToAP = true;
    else
    {
      #ifdef DEBUG
        DBG_OUTPUT_PORT.println( "" );
        DBG_OUTPUT_PORT.print( "Connected! IP address: " );
        DBG_OUTPUT_PORT.println( WiFi.softAPIP() );
      #endif

    }

  }
  else
  {
    #ifdef DEBUG
      DBG_OUTPUT_PORT.printf( "Connecting to %s\n", stName.c_str() );
    #endif
      
    WiFi.mode( WIFI_STA );
    WiFi.begin( stName.c_str(), stKey.c_str() );

    int reconCounter = 0;

    while ( WiFi.status() != WL_CONNECTED )
    {
      delay( 500 );
      #ifdef DEBUG
        DBG_OUTPUT_PORT.print( "." );
      #endif

      reconCounter++;

      if ( reconCounter == 20 )
      {
        revertToAP = true;
        
        break;

      }

    }

    IPAddress tempIP = WiFi.localIP();
    IPAddress goodIP = WiFi.localIP();
    IPAddress tempSubnet = WiFi.subnetMask();
    char changed = 0;

    for (int i = 0; i < 4; i++ )
    {
      if (  tempSubnet[ i ] == 0 )
      {
        tempIP[ i ] = stAddress.toInt();
        changed++;

      }

    }

    if ( changed == 1 )
    {
      WiFi.config( tempIP , WiFi.gatewayIP(), WiFi.subnetMask(), WiFi.dnsIP() );
      reconCounter = 0;

      while ( WiFi.status() != WL_CONNECTED )
      {
        delay( 500 );
        #ifdef DEBUG
          DBG_OUTPUT_PORT.print( "." );
        #endif
        
        reconCounter++;

        WiFi.config( goodIP , WiFi.gatewayIP(), WiFi.subnetMask(), WiFi.dnsIP() ); //revert back in case of collision, etc.

        if ( reconCounter == 20 )
        {
          revertToAP = true;
          
          break;

        }

      }

    }

    if ( WiFi.localIP() == IPAddress( 0, 0, 0, 0 ) )
      revertToAP = true;
    else
    {
      #ifdef DEBUG
        DBG_OUTPUT_PORT.println( "" );
        DBG_OUTPUT_PORT.print( "Connected! IP address: " );
        DBG_OUTPUT_PORT.println( WiFi.localIP() );
      #endif

    }

  }

  if ( revertToAP == true )
  {
    #ifdef DEBUG
      DBG_OUTPUT_PORT.println( "Reverting to default AP" );
    #endif
    
    wifiMode = "ap";
    WiFi.mode( WIFI_AP );
    WiFi.softAPConfig( local_IP, gateway, subnet );

  }

  if ( noConfig == true ) 
    loadConfig();
  
  MDNS.begin( host.c_str() );

  if ( wifiMode == "ap" )
    dnsServer.start( DNS_PORT, "*", WiFi.softAPIP() );
  else 
    dnsServer.start( DNS_PORT, "*", WiFi.localIP() );

  server.onNotFound( []()
  {
    if ( !handleFileRead( server.uri() ) )
    {
      #ifdef DEBUG
        DBG_OUTPUT_PORT.printf( "URI not found " );
      #endif
        
      digitalWrite( LED_BUILTIN, LOW );
      delay (500);
      digitalWrite( LED_BUILTIN, HIGH );

    }

  } );

  server.on( "/", HTTP_GET, [] ()
  {

    handleFileRead( "/index.html" );

  } );

  server.on( "/settings", HTTP_GET, [] ()
  {

    String sPage;

    if ( server.args() > 0 )
    {

      saveConfig();
      sPage = "<HTML><HEAD><meta http-equiv=\"refresh\" content=\"1; url=/index.html\"/></HEAD><TITLE>PS4 Exploit Settings</TITLE><BODY>Settings saved. Reset the card if network settings were changed!</BODY></HTML>";
      server.send( 200, "text/html", sPage );
      return;

    }

    loadConfig();

    sPage = "<HTML><HEAD><LINK REL=\"icon\" TYPE=\"image/png\" HREF=\"/ps4icon.png\"/><TITLE>PS4 Exploit Settings</TITLE></HEAD>\n<BODY>\n";
    sPage += "<FORM ID=\"form1\">\n<P>Wifi Mode</P>\n<DIV STYLE=\"margin-left: 1em;\">\n<INPUT TYPE =\"radio\" ID=\"ap\" NAME=\"wifimode\" VALUE=\"ap\"";
    if ( wifiMode == "ap" ) sPage +=  " checked";
    sPage += ">\n<LABEL FOR=\"ap\">Access Point</LABEL>\n<BR></BR>\n";
    sPage += "<DIV STYLE=\"margin-left: 2em;\">\nName: <INPUT ID=\"apname\" TYPE=\"text\" NAME=\"apname\" VALUE=\"" + apName + "\" onkeyup=\"apnameverify()\">\n<LABEL ID=\"apnamelabel\"></LABEL>\n<BR></BR>\n";
    sPage += "Password: <INPUT TYPE=\"password\" ID=\"apkey\" NAME=\"apkey\" VALUE=\"" + apKey + "\" onkeyup=\"apkeyverify()\">\n<LABEL ID=\"apkeylabel\"></LABEL>\n<BR></BR>\n</DIV>\n";
    sPage += "<INPUT TYPE =\"radio\" ID=\"sta\" NAME=\"wifimode\" VALUE=\"sta\"";
    if ( wifiMode == "sta" ) sPage += " checked";
    sPage += ">\n<LABEL FOR=\"sta\">Station</LABEL>\n<BR></BR>\n</DIV>\n<DIV STYLE=\"margin-left: 2em;\">\n";
    
    int n = WiFi.scanNetworks();

    if ( n == 0 )
    {
      sPage += "No networks found.\n<BR></BR>";
    }
    else
    {
      for ( int i = 0; i < n; ++i )
      {
        sPage += "<INPUT TYPE =\"radio\" ID=\"station" + String(i) + "\" NAME=\"stname\" VALUE=\"" + WiFi.SSID(i) + "\" ";
        if ( WiFi.SSID(i) == stName ) sPage += "checked";
        sPage += ">\n<LABEL FOR=\"station" + String(i, DEC) + "\">" + WiFi.SSID(i);
        if ( WiFi.encryptionType(i) == ENC_TYPE_NONE ) sPage += " (open)";
        sPage += "</LABEL>\n<BR></BR>\n";

      }

      sPage += "<DIV STYLE=\"margin-left: 2em;\">\nPassword: <INPUT TYPE=\"password\" NAME=\"stkey\" VALUE=\"" + stKey + "\">\n<BR></BR>\n";
      sPage += "Static IP: <INPUT TYPE=\"text\" ID=\"staddress\" NAME=\"staddress\" VALUE=\"" + stAddress + "\" onkeypress=\"return isNumber(event)\" onkeyup=\"staddressverify()\">\n<LABEL ID=\"staddresslabel\"></LABEL>\n<BR></BR>\n</DIV>\n";
    }

    sPage += "</DIV>\n<P>Payload</P>\n<DIV STYLE=\"margin-left: 1em;\">";

    Dir dir = SPIFFS.openDir( "/" );
    char firstFound = 0;

    while ( dir.next() )
    {
      String fileName = dir.fileName();

      if ( fileName.endsWith( ".bin" ) )
      {
        //String temp = fileName.substring( 1 );
        sPage += "\n<INPUT TYPE=\"radio\" ID=\"payload" + String(firstFound) + "\" NAME=\"payload\" VALUE=\"" + fileName + "\" " ;
        if ( fileName == payload ) sPage += "checked";
        firstFound ++;
        sPage += ">\n<LABEL FOR=\"payload" + String(firstFound, DEC) + "\">" + fileName.substring( 1 ) + "</LABEL>\n<BR></BR>";

      }

    }

    if ( firstFound == 0 )
    {
      sPage += "\nNo payloads found!\n<BR></BR>";
      payload = "";

    }

    sPage += "\n</DIV>\n<DIV>\n</FORM>\n<BUTTON TYPE=\"submit\" ID=\"submitbtn\" FORM=\"form1\" VALUE=\"Submit\">Save</BUTTON>\n\n";
    sPage += "<SCRIPT>\n\nfunction apnameverify() {\nendissubmit();\nif ( apname.value.length < 1 ) {\ndocument.getElementById('apnamelabel').innerHTML = \"Fill in an AP name\";\n}\nelse { document.getElementById('apnamelabel').innerHTML = \"\";\n}\n}\n";
    sPage += "\nfunction apkeyverify() {\nendissubmit();\nif ( apkey.value.length < 8 ) {\ndocument.getElementById('apkeylabel').innerHTML = \"Password must be at least 8 characters in length\";\n}\nelse { document.getElementById('apkeylabel').innerHTML = \"\";\n}\n}\n";
    sPage += "\nfunction endissubmit() {\nif ( ( apname.value.length < 1 ) || ( apkey.value.length < 8 ) ) {\nsubmitbtn.disabled = true;\n}\nelse {\nsubmitbtn.disabled = false;\n}\n}\n";
    sPage += "\nfunction isNumber( evt ) {\nnevt = ( evt ) ? evt : window.event;\nvar charCode = ( evt.which ) ? evt.which : evt.keyCode;\nif ( charCode > 31 && ( charCode < 48 || charCode > 57 ) ) {\nreturn false;\n}\nreturn true;\n}\n";
    sPage += "\nfunction staddressverify() {\nvar x= parseInt( staddress.value );\nif ( staddress.value == \"\" || ( ( x < 2 ) || ( x > 255 ) ) ) {\ndocument.getElementById('staddresslabel').innerHTML = \"Must be in range of 2 to 255\";\n}\nelse {\ndocument.getElementById('staddresslabel').innerHTML = \"\";\n}\n}\n\n";
    sPage += "</SCRIPT>\n</DIV>\n<BR></BR>\n</BODY>\n</HTML>";

    server.send( 200, "text/html", sPage );

  } );

  server.begin();

  #ifdef DEBUG
    DBG_OUTPUT_PORT.println( "HTTP server started" );
  #endif

}

void loop( void )
{

  ftpSrv.handleFTP();

  dnsServer.processNextRequest();
  
  server.handleClient();

  // force resend of payload on serial RX
  // #ifdef DEBUG
  //  if ( DBG_OUTPUT_PORT.available() ) 
  //    uploadPayload();
  // #endif
  
  if ( jsCounter == JS_MAX )
  {
    delay( 50 );
    uploadPayload();
    
    digitalWrite( LED_BUILTIN, LOW );
    delay (500);
    digitalWrite( LED_BUILTIN, HIGH );
      
  }

#ifdef SLEEP
  // read the state of the switch into a local variable:
  unsigned char reading = digitalRead( buttonPin );

  // If the switch changed, due to noise or pressing:
  if ( reading != lastButtonState )
  {
    // reset the debouncing timer
    lastDebounceTime = millis();
  }

  if ( (millis() - lastDebounceTime) > debounceDelay )
  {
    // whatever the reading is at, it's been there for longer than the debounce
    // delay, so take it as the actual current state:

    // if the button state has changed:
    if ( reading != buttonState )
    {
      buttonState = reading;

      // only toggle the LED if the new button state is HIGH
      if ( buttonState == LOW )
      {
        // ESP.deepSleep( 25e3 );
        ESP.deepSleep( 0 );
      }
    }
    
  }
#endif

}




